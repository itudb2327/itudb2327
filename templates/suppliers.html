{% extends "base.html" %}
{% block page_content %}
<link rel="stylesheet" href="{{url_for('static',filename='styles/suppliers.css')}}">

    <!-- Main container -->
    <div class="container" style="padding-top:8%;">
      <h1>Supplier Records</h1>
      <div class="table-container">
        <!-- Table container -->
        <table class="table table-striped" id="supplierTable">
          <thead>
            <!-- Table headers with sorting functionality -->
            <tr>
			{% if status == "admin" %}
              <th class="sortable">ID</th>
			{% endif %}  
              <th class="sortable">Company</th>
              <th class="sortable">Last Name</th>
              <th class="sortable">First Name</th>
              <th class="sortable">Email Address</th>
              <th class="sortable">Job Title</th>
              <th class="sortable">Business Phone</th>
			  {% if status == "admin" %}
              <th class="sortable">Home Phone</th>
              <th class="sortable">Mobile Phone</th>
			  {% endif %}
              <th class="sortable">Fax Number</th>
			  {% if status == "admin" %}
              <th class="sortable">Address</th>
			  {% endif %}
              <th class="sortable">City</th>
              <th class="sortable">State/Province</th>
			  {% if status == "admin" %}
              <th class="sortable">Zip/Postal Code</th>
			  {% endif %}
              <th class="sortable">Country/Region</th>
              <th class="sortable">Web Page</th>
			  {% if status == "admin" %}
              <th class="sortable">Notes</th>
              <th class="sortable">Attachments</th>
			  {% endif %}
            </tr>
          </thead>
          <tbody>
            <!-- Display supplier records from db--> 
			{% for record in records %} 
			<tr>
			{% if status == "admin" %}
              <td>{{ record[0] }}</td>
			{% endif %}  
              <td>{{ record[1] }}</td>
              <td>{{ record[2] }}</td>
              <td>{{ record[3] }}</td>
              <td>{{ record[4] }}</td>
              <td>{{ record[5] }}</td>
              <td>{{ record[6] }}</td>
			  {% if status == "admin" %}
              <td>{{ record[7] }}</td>
              <td>{{ record[8] }}</td>
			  {% endif %}
              <td>{{ record[9] }}</td>
			  {% if status == "admin" %}
              <td>{{ record[10] }}</td>
			  {% endif %}
              <td>{{ record[11] }}</td>
              <td>{{ record[12] }}</td>
			  {% if status == "admin" %}
              <td>{{ record[13] }}</td>
			  {% endif %}
              <td>{{ record[14] }}</td>
              <td>{{ record[15] }}</td>
			  {% if status == "admin" %}
              <td>{{ record[16] }}</td>
              <td>{{ record[17] }}</td>
			  {% endif %}
            </tr> {% endfor %}
          </tbody>
        </table>
      </div>
	    <div class="record-count">
			{% if status == "admin" %}
			<p>Total Records: {{ records|length }} Last Update Time: {{ update_time }}</p>
			{% endif %}
		</div>
      <div class="button-container">
	  <div class="location-button">
		<button id="location_btn" class="btn btn-info" data-toggle="modal" data-target="#locationModal" onclick="myFunction()">Find Nearest Supplier</button>      
      </div>
	  <div class="admin-buttons">
        <!-- Button container for update and add actions -->
		{% if status == "admin" %}
		<button id="updateButton" class="btn btn-primary" data-toggle="modal" data-target="#updateModal">Update Record</button>
        <button id="addButton" class="btn btn-success" data-toggle="modal" data-target="#myModal">Add New Record</button>
		{% endif %}
	  </div>
      </div>
      <!-- Modal for adding new records -->
      <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
	  
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h4 class="modal-title" id="myModalLabel">Enter new values</h4>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
				<!-- Form takes input one by one -->
              <div class="modal-split">
                <form action="/suppliers" method="post">
                  <label for="company">Company:</label>
                  <br>
                  <input type="text" id="company" name="company">
                  <br>
                
              </div>
              <div class="modal-split">
                  <label for="last_name">Last name:</label>
                  <br>
                  <input type="text" id="last_name" name="last_name">
                  <br>
              </div>
              <div class="modal-split">
                  <label for="first_name">First name:</label>
                  <br>
                  <input type="text" id="first_name" name="first_name">
                  <br>
              </div>
              <div class="modal-split">
                  <label for="email_address">Email Adress:</label>
                  <br>
                  <input type="text" id="email_address" name="email_address">
                  <br>
              </div>
              <div class="modal-split">
                  <label for="job_title">Job Title:</label>
                  <br>
                  <input type="text" id="job_title" name="job_title">
                  <br>
              </div>
              <div class="modal-split">
                  <label for="business_phone">Business Phone:</label>
                  <br>
                  <input type="text" id="business_phone" name="business_phone">
                  <br>
              </div>
			  <div class="modal-split">
                  <label for="home_phone">Home Phone:</label>
                  <br>
                  <input type="text" id="home_phone" name="home_phone">
                  <br>
              </div>
			  <div class="modal-split">
                  <label for="mobile_phone">Mobile Phone:</label>
                  <br>
                  <input type="text" id="mobile_phone" name="mobile_phone">
                  <br>
              </div>
              <div class="modal-split">
                  <label for="fax_number">Fax Number:</label>
                  <br>
                  <input type="text" id="fax_number" name="fax_number">
                  <br>
              </div>
              <div class="modal-split">
                  <label for="address">Address:</label>
                  <br>
                  <input type="text" id="address" name="address">
                  <br>
              </div>
              <div class="modal-split">
                  <label for="city">City:</label>
                  <br>
                  <input type="text" id="city" name="city">
                  <br>
              </div>
              <div class="modal-split">
                  <label for="state_province">State:</label>
                  <br>
                  <input type="text" id="state_province" name="state_province">
                  <br>
              </div>
              <div class="modal-split">
                  <label for="zip_postal_code">Zip/Postal Code:</label>
                  <br>
                  <input type="text" id="zip_postal_code" name="zip_postal_code">
                  <br>
              </div>
              <div class="modal-split">
                  <label for="country_region">Country:</label>
                  <br>
                  <input type="text" id="country_region" name="country_region">
                  <br>
              </div>
              <div class="modal-split">
                  <label for="web_page">Webpage:</label>
                  <br>
                  <input type="text" id="web_page" name="web_page">
                  <br>
              </div>
              <div class="modal-split">
                  <label for="notes">Any notes?</label>
                  <br>
                  <input type="text" id="notes" name="notes">
                  <br>
              </div>
			  <input type="hidden" name="operation" value="0"><!--operation 0 create-->

                </form>
            </div>
            <div class="modal-footer">
              <!--Footer -->
            </div>
          </div>
        </div>
      </div>
	  
	  
<div class="modal fade" id="updateModal" tabindex="-1" role="dialog" aria-labelledby="updateModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="updateModalLabel">Update Record</h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form action="/suppliers" method="post">
			<div class="form-group">
				<label for="updateId">Select ID:</label>
				<select id="updateId" name="updateId" class="form-control" onChange="document.querySelector('#updateIdInfo input').value = this.value" required>
					{% for record in records %}
						<option value="{{ record[0] }}">{{ record[0] }}</option>
					{% endfor %}
				</select>
			</div>
			
			
			<button type="button" id="updateButton" data-toggle="modal" data-target="#changeRecordModal" class="btn btn-primary">Update</button>
			<button type="button" class="btn btn-danger" data-toggle="modal" data-target="#deleteConfirmModal">Delete</button>
			
		</form>
         
      </div>
      <div class="modal-footer">
        <!-- Footer -->
      </div>
    </div>
  </div>
</div>

<!-- Add a confirmation modal for delete action -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" role="dialog" aria-labelledby="deleteConfirmModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="deleteConfirmModalLabel">Confirm Delete</h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this record?</p>
      </div>
      <div class="modal-footer">
			<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
	    <form action="/suppliers" method="post">
			<span id="updateIdInfo">
			<input type="hidden" value="1" name="updateId">
			</span >
			<input type="hidden" name="operation" value="1"><!--operation 1 delete-->
        <button type="submit" class="btn btn-danger" >Delete</button>
		</form>
      </div>
    </div>
  </div>
</div>
<!-- modal for displaying geolocation information -->
<div class="modal fade" id="locationModal" tabindex="-1" role="dialog" aria-labelledby="locationModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="locationModalLabel">Nearest Supplier</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
				{% if nearest_supplier == None %}
				<p id="location_out">Wait a second.</p>
				{% endif %}
				{% if nearest_supplier != None %}
				<p id="location_out">Nearest Supplier:</p>
				{% endif %}
				{% if nearest_supplier != None %}
				<p>{{nearest_supplier}}</p>
				{% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<!-- Modal for updating value -->
      <div class="modal fade" id="changeRecordModal" tabindex="-1" role="dialog" aria-labelledby="changeRecordModalLabel">
	  
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h4 class="modal-title" id="myModalLabel">Enter new values</h4>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
				<!-- Form takes input one by one -->
              <div class="modal-split">
                <form action="/suppliers" method="post">
                  <label for="company">Company:</label>
                  <br>
                  <input type="text" id="company" name="company">
                  <br>
                
              </div>
              <div class="modal-split">
                  <label for="last_name">Last name:</label>
                  <br>
                  <input type="text" id="last_name" name="last_name">
                  <br>
              </div>
              <div class="modal-split">
                  <label for="first_name">First name:</label>
                  <br>
                  <input type="text" id="first_name" name="first_name">
                  <br>
              </div>
              <div class="modal-split">
                  <label for="email_address">Email Adress:</label>
                  <br>
                  <input type="text" id="email_address" name="email_address">
                  <br>
              </div>
              <div class="modal-split">
                  <label for="job_title">Job Title:</label>
                  <br>
                  <input type="text" id="job_title" name="job_title">
                  <br>
              </div>
              <div class="modal-split">
                  <label for="business_phone">Business Phone:</label>
                  <br>
                  <input type="text" id="business_phone" name="business_phone">
                  <br>
              </div>
			  <div class="modal-split">
                  <label for="home_phone">Home Phone:</label>
                  <br>
                  <input type="text" id="home_phone" name="home_phone">
                  <br>
              </div>
			  <div class="modal-split">
                  <label for="mobile_phone">Mobile Phone:</label>
                  <br>
                  <input type="text" id="mobile_phone" name="mobile_phone">
                  <br>
              </div>
              <div class="modal-split">
                  <label for="fax_number">Fax Number:</label>
                  <br>
                  <input type="text" id="fax_number" name="fax_number">
                  <br>
              </div>
              <div class="modal-split">
                  <label for="address">Address:</label>
                  <br>
                  <input type="text" id="address" name="address">
                  <br>
              </div>
              <div class="modal-split">
                  <label for="city">City:</label>
                  <br>
                  <input type="text" id="city" name="city">
                  <br>
              </div>
              <div class="modal-split">
                  <label for="state_province">State:</label>
                  <br>
                  <input type="text" id="state_province" name="state_province">
                  <br>
              </div>
              <div class="modal-split">
                  <label for="zip_postal_code">Zip/Postal Code:</label>
                  <br>
                  <input type="text" id="zip_postal_code" name="zip_postal_code">
                  <br>
              </div>
              <div class="modal-split">
                  <label for="country_region">Country:</label>
                  <br>
                  <input type="text" id="country_region" name="country_region">
                  <br>
              </div>
              <div class="modal-split">
                  <label for="web_page">Webpage:</label>
                  <br>
                  <input type="text" id="web_page" name="web_page">
                  <br>
              </div>
              <div class="modal-split">
                  <label for="notes">Any notes?</label>
                  <br>
                  <input type="text" id="notes" name="notes">
                  <br>
              </div>
			  <input type="hidden" name="operation" value="2"><!--operation 2 update-->
			  <span id="updateIdInfo">
				<input type="hidden" value="1" name="updateId">
			  </span >
				<!-- <input> -->
                </form>
            </div>
            <div class="modal-footer">
              <!--Footer -->
            </div>
          </div>
        </div>
      </div>	  
    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
      $(document).ready(function() {
        $('th.sortable').click(function() {
          var table = $(this).parents('table').eq(0);
          var rows = table.find('tr:gt(0)').toArray();
          var isAscending = $(this).hasClass('asc');
          // Remove the "asc" class from all headers
          $('th.sortable').removeClass('asc');
          if (isAscending) {
            $(this).removeClass('asc');
          } else {
            $(this).addClass('asc');
          }
          rows.sort(comparator($(this).index()));
          if (!isAscending) {
            rows = rows.reverse();
          }
          for (var i = 0; i < rows.length; i++) {
            table.append(rows[i]);
          }
        });

        function comparator(index) {
          return function(a, b) {
            var valA = getCellValue(a, index),
              valB = getCellValue(b, index);
            return $.isNumeric(valA) && $.isNumeric(valB) ? valA - valB : valA.toString().localeCompare(valB);
          }
        }

        function getCellValue(row, index) {
          return $(row).children('td').eq(index).text();
        }
      });
    </script>
    <script>
      $(document).ready(function() {
        prep_modal();
      });

      function prep_modal() {
        $(".modal").each(function() {
          var element = this;
          var pages = $(this).find('.modal-split');
          if (pages.length != 0) {
            pages.hide();
            pages.eq(0).show();
            var b_button = document.createElement("button");
            b_button.setAttribute("type", "button");
            b_button.setAttribute("class", "btn btn-primary");
            b_button.setAttribute("style", "display: none;");
            b_button.innerHTML = "Back";
            var n_button = document.createElement("button");
            n_button.setAttribute("type", "button");
            n_button.setAttribute("class", "btn btn-primary");
            n_button.innerHTML = "Next";
            $(this).find('.modal-footer').append(b_button).append(n_button);
            var page_track = 0;
            $(n_button).click(function() {
              this.blur();
              if (page_track == 0) {
                $(b_button).show();
              }
              if (page_track == pages.length - 2) {
                $(n_button).text("Submit");
              }
              if (page_track == pages.length - 1) {
                console.log($(element).find("form").serialize());
                $(element).find("form").submit();
              }
              if (page_track < pages.length - 1) {
                page_track++;
                pages.hide();
                pages.eq(page_track).show();
              }
            });
            $(b_button).click(function() {
              if (page_track == 1) {
                $(b_button).hide();
              }
              if (page_track == pages.length - 1) {
                $(n_button).text("Next");
              }
              if (page_track > 0) {
                page_track--;
                pages.hide();
                pages.eq(page_track).show();
              }
            });
          }
        });
      }
    </script>
    <script>
      $(document).on("keydown", "form", function(event) {
        return event.key != "Enter";
      });
    </script>
	<script>
		const x = document.getElementById("location_out");
		
		document.getElementById("location_btn").addEventListener("click", getLocation);
		
		function getLocation() {
		  if (navigator.geolocation) {
			navigator.geolocation.getCurrentPosition(showPosition);
		  } else { 
			x.innerHTML = "Geolocation is not supported by this browser.";
		  }
		}


		function showPosition(position) {
		  x.innerHTML = "Latitude: " + position.coords.latitude + 
		  "<br>Longitude: " + position.coords.longitude;

		  // Create a form dynamically
		  const form = document.createElement("form");
		  form.setAttribute("method", "post");
		  form.setAttribute("action", "/suppliers"); 

		  // Create input fields for latitude and longitude
		  const latInput = document.createElement("input");
		  latInput.setAttribute("type", "hidden");
		  latInput.setAttribute("name", "latitude");
		  latInput.setAttribute("value", position.coords.latitude);

		  const lonInput = document.createElement("input");
		  lonInput.setAttribute("type", "hidden");
		  lonInput.setAttribute("name", "longitude");
		  lonInput.setAttribute("value", position.coords.longitude);

		  // Append input fields to the form
		  form.appendChild(latInput);
		  form.appendChild(lonInput);

		  // Append the form to the document body and submit it
		  document.body.appendChild(form);
		  form.submit();
		}
	</script>
<script>
    window.onload = function() {
        const x = document.getElementById("location_out");

        // Assume nearest_supplier is a variable available in the template
        var y = '{{ nearest_supplier }}'; // Wrap in quotes

        console.log(y);

        // Check if y is not an empty string
        if (y !== 'None') {
            // Add JavaScript code to show the modal
            $(document).ready(function(){
                $('#locationModal').modal('show');
            });
        }
    };
</script>

	
{% endblock %}